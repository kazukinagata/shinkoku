# 確定申告書等作成コーナー 画面遷移マップ

## 調査日
2026-02-19

## 選択したルート
1. e-Taxルート: マイナンバーカード → スマートフォン（QRコード）→ 決算書・収支内訳書（＋所得税）→ マイナポータル連携なし → **QR認証でブロック**
2. 書面提出ルート: マイナンバーカード: いいえ → 書面 → 青色申告決算書 → **決算書入力完了** ★採用ルート

## 画面遷移フロー

```
CC-AA-010 税務署への提出方法の選択
  ├─ マイナンバーカード: はい → スマホ/ICカードリーダ: はい
  │   ├─ スマートフォンを使用する → doSubmitCSW0100('1','3','/ky/sm/csw0100_myno_qr')
  │   └─ ICカードリーダライタを使用する → doSubmitCSW0100('2','3','/ky/sm/csw0100_myno_ic')
  │
  ▼
CC-AE-090 作成する申告書等の選択 (/ky/sm/csw0100_myno_qr)
  ├─ 令和7年分
  │   ├─ 所得税 → doSubmitCMW0900(1,'25')
  │   ├─ 決算書・収支内訳書（＋所得税） → doSubmitCMW0900(2,'25') ★メインパス
  │   ├─ 消費税 → doSubmitCMW0900(3,'25')
  │   └─ 贈与税 → doSubmitCMW0900(4,'25')
  │
  ▼
CC-AE-600 マイナポータル連携の選択 (/ky/sm/cmw0900_kessan)
  ├─ マイナポータル連携を利用する → btnDataCheckRenkei(this)
  └─ マイナポータル連携を利用しない → btnDataCheckNotRenkei(this) ★選択
  │
  ▼ (次へ進む)
CC-AA-024 e-Taxを行う前の確認 (/ky/sm/cmw6000)
  │  推奨環境確認・マイナポータルアプリ案内・利用規約
  │
  ▼ (利用規約に同意して次へ)
CC-AA-440 QRコード認証 (/ky/sm/csw0240)
  │  ★ここでユーザーの物理的認証が必要
  │  スマートフォンでQRコード読み取り → マイナンバーカード認証
  │
  ▼ (認証完了後、自動遷移)
CC-AA-530? e-Tax登録（初回利用者のみ）
  │
  ▼
CC-AA-540? 事前確認完了
  │
  ▼
??? 申告書作成画面（未調査）
```

### 書面提出ルート（★採用）

```
CC-AA-010 税務署への提出方法の選択
  ├─ マイナンバーカード: いいえ
  │   → 提出方法: 書面 を選択
  │   → doSubmitCSW0100('2', '1', '/ky/sm/csw0100_print1?q1=w3&q2=x2&q3=y2&q4=z8')
  │   ※ モーダル3連鎖（e-Tax推奨→アンケート→メリット説明）を回避
  │
  ▼
CC-AA-030 書面提出の事前確認 (/ky/sm/csw0100_print1)
  │
  ▼ (次へ進む)
CC-AA-090 作成する申告書等の選択（書面） (/kyoutu/ky/sm/csw0900)
  │  doSubmitCSW0900(2,'25') → 決算書・収支内訳書
  │
  ▼
CC-AA-450 XMLデータ読込 (/ky/sm/csw0900_kessan)
  │  前年データの読込（スキップ可）
  │
  ▼ (次へ進む)
/kessan/ac/r7/top 決算書作成コーナートップ
  │
  ▼ (次へ進む)
/kessan/ac/r7/kakutei/convert/ac0300 (遷移処理)
  │
  ▼
/kessan/ac/pre/ac0300 作成する決算書・収支内訳書の選択
  │  radio: 青色申告決算書 / 収支内訳書 / 青色申告決算書（現金主義用）
  │
  ▼ (次へ進む)
/kessan/ac/aa0200 決算書（一般用）の入力 ★P/L入力
  │  損益計算書: 売上・原価・経費・繰戻・専従者給与
  │  ├─ 「入力」ボタン → /kessan/ac/aa0201 売上仕入金額の月別入力
  │
  ▼ (次へ進む)
/kessan/ac/submit/aa0200 → /kessan/ac/pre/ac0300 青色申告決算書の種類選択ハブ
  │  営業等所得・農業所得・不動産所得・雑所得（業務）の入力状況を表示
  │
  ▼ (次へ進む)
/kessan/ac/submit/aa0100 青色申告特別控除の入力
  │  Q&A形式:
  │  1. 控除額選択: 10万円(value=2) / 55万円(value=3) / 65万円(value=1)
  │  2. 電子帳簿保存の質問（65万円時のみ）
  │  3. 貸借対照表作成の質問
  │  ※ 書面提出で65万円→エラー KS-E10089
  │
  ▼ (次へ進む)
/kessan/ac/preAoiroCalc 青色申告特別控除計算処理
  │
  ▼
貸借対照表（一般用）の入力 ★B/S入力
  │  資産の部 / 負債・資本の部
  │  期首・期末の各部合計一致が必要
  │
  ▼ (次へ進む)
/kessan/ac/submit/aa0700 所得金額の確認（読み取り専用）
  │  営業等所得: ①控除前所得 / ②青色控除 / ③所得金額
  │
  ▼ (次へ進む)
/kessan/ac/ac0500 住所・氏名等の入力
  │  納税地区分、住所、事業所住所、提出先税務署、提出年月日、氏名、業種名、屋号
  │  ※ 郵便番号→住所自動入力、都道府県→市区町村/税務署名を動的ロード
  │
  ▼ (次へ進む)
/kessan/ac/submit/ac0500 決算書・収支内訳書の印刷
  │  提出用・控用PDFの選択と印刷
  │  「決算書等表示・印刷」→PDFダウンロード
  │
  ▼ (次へ進む) ※ confirm KS-W10035（印刷未確認）
/kessan/ac/submit/ac0600 印刷した後の作業について（データ保存等）
  │  1. 入力データの保存（.dataファイル）
  │  2. 補完記入の案内
  │  3. 添付書類の確認
  │  4. 申告書作成への誘導
  │     ├─ 「所得税の申告書作成はこちら」→ 確定申告書Bへ遷移（住所氏名引継ぎ）
  │     └─ 「消費税の申告書作成はこちら」→ 消費税申告書へ遷移（収入金額引継ぎ）
  │
  ▼ (終了する)
  作成完了
```

## 技術的な知見

### SPA構造
- jQuery 3 + jQuery UI ベース
- ページ遷移はフォーム POST（`document.forms[formName].submit()`）
- ハッシュ `#bsctrl` はページ管理用

### 主要スクリプトファイル
- `ta_common.js` — 共通ユーティリティ
- `ta_option_util.js` — オプションユーティリティ
- `ta_zeimusyo.js` — 税務署関連
- `ta_client_validator.js` — クライアントバリデーション
- `main.js` — メインロジック

### 環境チェック
- `getClientOSVersionAsync()` → OS検出
- `isRecommendedOsAsEtaxAsync()` → OS推奨チェック
- `isRecommendedBrowserAsEtaxAsync(1)` → ブラウザ推奨チェック
- `termnalInfomationCheckOS_myNumberLinkage()` → 総合環境チェック
- Linux環境: `isTransition=false` で完全ブロック → フォーム直接submit()で回避

### フォーム命名規則
- `csw0100InputInfo` — 提出方法選択フォーム
- `cmw0900InputInfo`? — 申告書種類選択フォーム（推定）
