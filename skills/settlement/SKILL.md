---
name: settlement
description: >
  This skill should be used when the user needs to perform year-end closing
  adjustments (決算整理), generate financial statements (決算書), compute
  depreciation, or review their trial balance. Trigger phrases include:
  "決算", "決算整理", "決算書を作る", "減価償却", "試算表", "残高試算表",
  "損益計算書", "貸借対照表", "BS", "PL", "決算書PDF", "期末処理",
  "棚卸し", "未払計上", "前払処理".
---

# 決算整理・決算書作成（Year-End Settlement）

会計年度末の決算整理仕訳を登録し、残高試算表・損益計算書・貸借対照表を生成するスキル。
journal スキルで日常仕訳の入力が完了していることを前提とする。

## 設定の読み込み（最初に実行）

1. `shinkoku.config.yaml` を Read ツールで読み込む
2. ファイルが存在しない場合は `/setup` スキルの実行を案内して終了する
3. 設定値を把握し、相対パスは CWD を基準に絶対パスに変換する:
   - `db_path`: MCP ツールの `db_path` 引数に使用
   - `output_dir`: PDF 生成時の `output_path` 引数のベースディレクトリに使用
   - 各ディレクトリ: ファイル参照時に使用

### パス解決の例

config の `db_path` が `./shinkoku.db`、`output_dir` が `./output` で CWD が `/home/user/tax-2025/` の場合:
- `ledger_trial_balance(db_path="/home/user/tax-2025/shinkoku.db", ...)`
- `generate_bs_pl_pdf(output_path="/home/user/tax-2025/output/bs_pl_2025.pdf", ...)`

## 基本方針

- journal スキルでの仕訳入力が完了しているか確認してから開始する
- 残高試算表で勘定残高を確認し、決算整理仕訳の必要性を判定する
- 減価償却は references/depreciation-rules.md のルールに基づいて計算する
- 決算整理仕訳も登録前に必ずユーザーに確認する
- 最終的に貸借対照表の貸借一致を検証する

## 前提条件の確認

決算処理を開始する前に以下を確認する:

1. **日常仕訳が完了しているか**: 未記帳の取引がないか確認を促す
2. **会計年度**: 対象年度を確認する（例: 2025年1月1日〜12月31日）
3. **青色申告の種類**: 65万円控除（複式簿記）か10万円控除（簡易簿記）か

## ステップ1: 残高試算表の確認

### `ledger_trial_balance` の呼び出し

```
パラメータ:
  db_path: str
  fiscal_year: int — 会計年度

戻り値:
  - accounts: 各勘定科目の借方合計・貸方合計・残高
  - total_debit: 借方合計
  - total_credit: 貸方合計
```

**確認項目:**

1. 借方合計と貸方合計が一致しているか
2. 各科目の残高が妥当か（マイナス残高の有無）
3. 以下の科目に残高がある場合、決算整理が必要:
   - 仮払金（1060）→ 精算して適切な科目に振り替える
   - 仮受金（2060）→ 内容を確定して振り替える
   - 仮払消費税（1090）/ 未払消費税（2070）→ 消費税の計算結果を反映する

## ステップ2: 決算整理仕訳の登録

以下の決算整理項目を順に確認・処理する。各仕訳は `ledger_add_journal` で登録する。

### 2-1. 減価償却費の計上

固定資産（1100〜1160）に残高がある場合、減価償却費を計上する。

**計算ツールの呼び出し:**

定額法の場合: `calc_depreciation_straight_line`
```
パラメータ:
  acquisition_cost: int  — 取得原価
  useful_life: int       — 耐用年数
  residual_rate: float   — 残存価額率（通常0、旧定額法は0.1）
  months_used: int       — 当期の使用月数（期中取得の場合は月割り）
```

定率法の場合: `calc_depreciation_declining_balance`
```
パラメータ:
  acquisition_cost: int  — 取得原価
  book_value: int        — 期首帳簿価額
  useful_life: int       — 耐用年数
  months_used: int       — 当期の使用月数
```

**仕訳の登録:**
```
借方: 減価償却費(5200) / 貸方: 該当の固定資産科目
金額: 計算された償却額
```

- 耐用年数は references/depreciation-rules.md を参照する
- 事業供用開始日が期中の場合は月割り計算を行う
- 一括償却資産（1160）は取得原価の1/3を計上する（3年均等償却）
- 家事按分がある場合は事業使用割合を乗じた金額のみ計上する

### 2-2. 棚卸資産の評価

期末に在庫がある場合、棚卸高を計上する。

```
期末棚卸仕訳:
借方: 棚卸資産(1030) / 貸方: 仕入(5001)  金額: 期末棚卸高

期首棚卸仕訳（翌期首に自動振替する場合の備忘）:
借方: 仕入(5001) / 貸方: 棚卸資産(1030)  金額: 期首棚卸高
```

- 期末の在庫数量と単価をユーザーに確認する
- 評価方法（最終仕入原価法等）を確認する

### 2-3. 未払費用の計上

年度末時点で発生しているが未払いの費用を計上する。

```
借方: 該当の費用科目 / 貸方: 未払費用(2031)
```

- 12月分の家賃（翌月払いの場合）
- 12月分の通信費・光熱費
- 社会保険料の未払い分

### 2-4. 前払費用の計上

翌期分を当期に支払い済みの場合、前払費用に振り替える。

```
借方: 前払費用(1041) / 貸方: 該当の費用科目
```

- 年払いの保険料のうち翌期対応分
- 年払いのサブスクリプション料金のうち翌期対応分

### 2-5. 売掛金・買掛金の確認

- 売掛金（1010）残高と未回収の請求書一覧が一致するか確認する
- 買掛金（2001）残高と未払いの仕入先一覧が一致するか確認する
- 回収不能な売掛金がある場合は貸倒金（5260）への振替を検討する

### 2-6. 事業主勘定の確認

- 事業主貸（1200）: 事業資金から個人利用分の合計
- 事業主借（3010）: 個人資金から事業利用分の合計
- これらは決算で相殺しない（翌期首に元入金で繰越処理する）

## ステップ3: 決算書の生成

決算整理仕訳がすべて登録された後、決算書を生成する。

### 3-1. 損益計算書の確認（`ledger_pl`）

```
パラメータ:
  db_path: str
  fiscal_year: int

戻り値:
  - revenue: 収益の内訳と合計
  - expenses: 費用の内訳と合計
  - net_income: 当期純利益（収益合計 − 費用合計）
```

**確認項目:**
- 売上金額が実績と一致するか
- 各経費科目が妥当か（異常に大きい・小さい科目がないか）
- 青色申告特別控除前の所得金額を確認する

### 3-2. 貸借対照表の確認（`ledger_bs`）

```
パラメータ:
  db_path: str
  fiscal_year: int

戻り値:
  - assets: 資産の内訳と合計
  - liabilities: 負債の内訳と合計
  - equity: 純資産の内訳と合計
```

**確認項目:**
- 資産合計 = 負債合計 + 純資産合計 であるか（貸借一致）
- 現金・預金残高が実際の残高と一致するか
- 固定資産の帳簿価額が減価償却後の金額であるか

### 3-3. 決算書PDFの生成（`generate_bs_pl_pdf`）

```
パラメータ:
  fiscal_year: int
  db_path: str
  output_path: str — 出力先のファイルパス
```

- 損益計算書と貸借対照表を1つのPDFファイルに出力する
- 青色申告決算書の様式に準拠した形式で生成する
- 出力後、ファイルパスをユーザーに案内する

## ステップ4: 決算結果サマリーの提示

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
決算結果サマリー（令和○年分）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

■ 損益計算書
  売上高:         ○○○,○○○円
  売上原価:       ○○○,○○○円
  経費合計:       ○○○,○○○円
  青色申告特別控除前の所得: ○○○,○○○円

■ 貸借対照表
  資産合計:       ○○○,○○○円
  負債合計:       ○○○,○○○円
  純資産合計:     ○○○,○○○円
  貸借差額:       0円（一致）

■ 決算整理仕訳: N件
  - 減価償却費: ○○○,○○○円
  - 棚卸調整:   ○○○,○○○円
  - 未払計上:   ○○○,○○○円

■ 出力ファイル:
  → [出力パス]/bs_pl_2025.pdf

■ 次のステップ:
  → income-tax スキルで所得税の計算を行う
  → consumption-tax スキルで消費税の計算を行う
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```
