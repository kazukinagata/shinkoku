---
name: journal
description: >
  This skill should be used when the user wants to record bookkeeping entries
  (仕訳), import transaction data from CSV files, receipts, or invoices, or
  manage their general ledger. Trigger phrases include: "仕訳を入力",
  "仕訳登録", "CSVを取り込む", "レシートを読み込む", "請求書を取り込む",
  "帳簿を付ける", "経費を記録", "売上を記録", "仕訳を修正", "仕訳を検索",
  "仕訳を削除", "取引を登録", "帳簿の初期化".
---

# 仕訳入力・帳簿管理（Journal Entry & Ledger Management）

CSV・レシート・請求書からデータを取り込み、ユーザー確認のうえ仕訳を登録するスキル。
帳簿の初期化、仕訳の検索・修正・削除も本スキルで対応する。

## 設定の読み込み（最初に実行）

1. `shinkoku.config.yaml` を Read ツールで読み込む
2. ファイルが存在しない場合は `/setup` スキルの実行を案内して終了する
3. 設定値を把握し、相対パスは CWD を基準に絶対パスに変換する:
   - `db_path`: MCP ツールの `db_path` 引数に使用
   - `output_dir`: PDF 生成時の `output_path` 引数のベースディレクトリに使用
   - 各ディレクトリ: ファイル参照時に使用

### パス解決の例（db_path）

config の `db_path` が `./shinkoku.db` で CWD が `/home/user/tax-2025/` の場合、MCP ツールには絶対パス `/home/user/tax-2025/shinkoku.db` を渡す。`ledger_init`, `ledger_add_journal`, `ledger_add_journals_batch`, `ledger_search`, `ledger_update_journal`, `ledger_delete_journal` すべてに同じ絶対パスを使用する。

## 基本方針

- CSV取り込み → ユーザー確認 → 仕訳登録 の3ステップを基本フローとする
- 勘定科目は references/account-master.md のマスタデータに準拠する
- 仕訳登録前に必ずユーザーに内容を確認する（自動登録しない）
- 消費税区分（課税/非課税/不課税/対象外）を正確に設定する
- 日付・金額・勘定科目の整合性を検証してからツールを呼び出す
- エラー発生時はエラー内容を日本語で分かりやすく伝え、修正方法を提案する

## 前提条件の確認

仕訳入力を開始する前に以下を確認する:

1. **帳簿が初期化済みか**: 未初期化の場合は `ledger_init` で初期化を案内する
2. **会計年度**: 対象の会計年度（例: 2025）を確認する
3. **青色申告 or 白色申告**: 複式簿記（青色65万円控除）か簡易簿記かで記帳方法が変わる

## ステップ1: 帳簿の初期化

初回利用時、または新しい会計年度を開始する際に帳簿を初期化する。

### `ledger_init` の呼び出し

```
パラメータ:
  fiscal_year: int  — 会計年度（例: 2025）
  db_path: str      — データベースファイルのパス
```

- 会計年度と保存先パスをユーザーに確認してから実行する
- 既存のデータベースがある場合は上書き警告を表示する
- 初期化完了後、勘定科目マスタが登録されたことを確認する

## ステップ2: データの取り込み

ユーザーが持つ取引データの形式に応じて適切なインポートツールを選択する。

### 2-1. CSV取り込み（`import_csv`）

クレジットカード明細・銀行取引明細・会計ソフトのエクスポートデータ等を読み込む。

```
パラメータ:
  file_path: str — CSVファイルのパス

戻り値:
  - headers: 検出されたカラムヘッダ一覧
  - rows: パースされた各行のデータ
  - encoding: 自動検出されたエンコーディング
  - row_count: 行数
```

**取り込み後の処理手順:**

1. 取り込まれたデータのプレビューを表示する（先頭5〜10行）
2. 日付・金額・摘要のカラムを特定してユーザーに確認する
3. 各行に対して勘定科目の推定を行い、候補を提示する
4. 推定根拠を明示する（摘要のキーワードマッチ等）
5. ユーザーが科目を確認・修正したら仕訳データに変換する

**勘定科目の推定ルール:**

- 摘要に「電車」「バス」「タクシー」「JR」→ 旅費交通費（5130）
- 摘要に「Amazon」「ヨドバシ」→ 消耗品費（5190）または事務用品費（5360）
- 摘要に「ドコモ」「au」「ソフトバンク」→ 通信費（5140）
- 摘要に「東京電力」「ガス」「水道」→ 水道光熱費（5120）
- 摘要に「家賃」「賃料」→ 地代家賃（5250）
- 推定できない場合は「不明」として候補一覧を提示し、ユーザーに選択を求める

### 2-2. レシート取り込み（`import_receipt`）

紙のレシート・領収書の画像ファイルからOCRでデータを抽出する。

**重要: 画像の読み取りは receipt-reader サブエージェントに委任する。** メインコンテキストで直接 Read ツールによる画像読み取りを行わないこと（Vision トークンでコンテキストが圧迫されるため）。

#### 単一レシートの場合

1. `import_receipt` でファイルの存在を確認する
2. **Task ツールで receipt-reader サブエージェントに画像読み取りを委任する:**
   ```
   Task(
     subagent_type="receipt-reader",
     prompt="以下のレシート画像を読み取り、構造化データを返してください: {ファイルパス}"
   )
   ```
3. サブエージェントから返された `---RECEIPT_DATA---` ブロックの内容を解析する
4. 日付・金額・店舗名をユーザーに表示して正しいか確認する
5. 品目から勘定科目を推定する
6. 家事按分の必要性を確認する（自宅兼事務所の場合等）
7. 確認後、仕訳データに変換する

#### 複数レシートの一括処理

1. Glob ツールでレシート画像の一覧を取得する（例: `receipts/*.jpg`, `receipts/*.png`）
2. `import_receipt` で各ファイルの存在を確認する
3. **全ファイルパスをまとめて receipt-reader サブエージェントに渡す:**
   ```
   Task(
     subagent_type="receipt-reader",
     prompt="以下のレシート画像をすべて読み取り、各ファイルの構造化データを返してください:\n- {パス1}\n- {パス2}\n- ..."
   )
   ```
4. サブエージェントから返された各レシートの結果をまとめてユーザーに提示する
5. 各レシートの勘定科目を推定し、一覧でユーザーに確認する
6. 確認後、`ledger_add_journals_batch` で一括登録する

### 2-3. 請求書取り込み（`import_invoice`）

PDFの請求書からテキストを抽出する。

```
パラメータ:
  file_path: str — PDFファイルのパス

戻り値:
  - vendor: 請求元
  - date: 請求日
  - due_date: 支払期日
  - amount: 請求金額
  - tax_amount: 消費税額
  - items: 明細行
  - raw_text: 抽出生テキスト
```

**取り込み後の処理手順:**

1. 抽出結果を表示し、金額・日付・取引先が正しいか確認する
2. インボイス番号（T+13桁）の有無を確認する
3. 消費税の税率区分（10%/8%軽減税率）を確認する
4. 発生主義で未払金を計上するか、現金主義で処理するか確認する
5. 確認後、仕訳データに変換する

## ステップ2.5: 重複チェック（CSVインポート時）

CSVインポートのフローに重複チェックを組み込む:

1. **ファイル重複チェック**: `import_check_csv_imported` でファイルのハッシュを確認
   - 既にインポート済みの場合はユーザーに警告し、再インポートの意思を確認する
2. **仕訳登録時の自動チェック**: `ledger_add_journals_batch` が自動的に重複を検出
   - exact（完全一致）: 登録をブロック、既存の仕訳IDを表示
   - similar（類似）: 警告を表示し、ユーザーに確認を求める
   - ユーザーが「登録する」と回答した場合は force=True で再実行
3. **インポート記録**: 登録成功後、`import_record_source` でインポート履歴を記録する

### 申告前の重複チェック

決算処理の前に `ledger_check_duplicates` を実行し、重複の疑いのある仕訳ペアを一覧表示する。
ユーザーに確認の上、不要な重複は `ledger_delete_journal` で削除する。

## ステップ3: 仕訳の登録

ユーザーが確認したデータを帳簿に登録する。

### 3-1. 単一仕訳の登録（`ledger_add_journal`）

```
パラメータ:
  db_path: str
  entry: JournalEntry
    - date: str          — 日付（YYYY-MM-DD）
    - debit_code: str    — 借方勘定科目コード
    - credit_code: str   — 貸方勘定科目コード
    - amount: int        — 金額（円）
    - description: str   — 摘要
    - tax_rate: float | None — 消費税率（0.10 / 0.08 / None）
```

### 3-2. 一括仕訳登録（`ledger_add_journals_batch`）

CSV取り込み等で複数の仕訳を一度に登録する場合に使用する。

```
パラメータ:
  db_path: str
  entries: list[JournalEntry] — 仕訳エントリのリスト
```

**登録前の確認事項:**

- 登録件数と合計金額をサマリーとして提示する
- 「以下の N 件の仕訳を登録します。よろしいですか？」と確認する
- ユーザーの明示的な承認を得てから `ledger_add_journals_batch` を実行する

### 登録時の検証ルール

以下を検証し、不備があれば登録前に警告する:

1. **日付の妥当性**: 会計年度の範囲内であるか（例: 2025-01-01 〜 2025-12-31）
2. **勘定科目の存在**: 借方・貸方の科目コードがマスタに存在するか
3. **金額の正値**: 金額が正の整数であるか
4. **貸借の一致**: 複合仕訳の場合、借方合計 = 貸方合計であるか
5. **消費税区分の整合**: 科目の tax_category と税率の組み合わせが妥当か

## ステップ4: 仕訳の検索

登録済みの仕訳を検索する。

### `ledger_search` の呼び出し

```
パラメータ:
  db_path: str
  params: JournalSearchParams
    - date_from: str | None — 開始日
    - date_to: str | None   — 終了日
    - account_code: str | None — 勘定科目コード
    - description: str | None  — 摘要キーワード
    - amount_min: int | None   — 金額下限
    - amount_max: int | None   — 金額上限
```

**検索結果の表示:**

- 検索結果を日付順の一覧表で表示する
- 各仕訳には journal_id を表示する（修正・削除で使用）
- 合計金額を末尾に表示する

## ステップ5: 仕訳の修正・削除

### 5-1. 仕訳の修正（`ledger_update_journal`）

```
パラメータ:
  db_path: str
  journal_id: int    — 修正対象の仕訳ID
  entry: JournalEntry — 修正後の仕訳データ
```

- 修正前後の差分を表示してから確認する
- 修正理由を摘要に追記することを推奨する

### 5-2. 仕訳の削除（`ledger_delete_journal`）

```
パラメータ:
  db_path: str
  journal_id: int — 削除対象の仕訳ID
```

- 削除対象の仕訳内容を表示して確認する
- 「この仕訳を削除します。よろしいですか？」と最終確認する
- 削除は取り消しできない旨を注意喚起する

## よくある仕訳パターン

### 売上の計上

```
借方: 売掛金(1010) / 貸方: 売上(4001)   金額: 110,000円  税率: 10%
摘要: ○○社 Webサイト制作費 請求書No.2025-001
```

### 経費の支払い（事業用口座から）

```
借方: 消耗品費(5190) / 貸方: 普通預金(1002)  金額: 5,500円  税率: 10%
摘要: Amazon ワイヤレスキーボード
```

### 個人の財布から事業経費を支払った場合

```
借方: 旅費交通費(5130) / 貸方: 事業主借(3010)  金額: 1,200円  税率: 10%
摘要: JR 新宿→渋谷 打ち合わせ往復
```

### 事業資金を個人利用した場合

```
借方: 事業主貸(1200) / 貸方: 普通預金(1002)  金額: 50,000円
摘要: 生活費引き出し
```

## 次のステップの案内

仕訳入力が完了したら、以下を案内する:

- `settlement` スキルで決算整理・決算書作成を行う
- `ledger_trial_balance` で残高試算表を確認して仕訳漏れがないか検証する
- 全取引の登録完了を確認してから決算処理に進む
